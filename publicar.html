<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Publicar | NexusShop</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background: linear-gradient(135deg, #e6eefc 0%, #fbeff3 100%);
        }
        .slides {
            display: flex;
            transition: transform 300ms ease;
        }
        .slide {
            min-width: 100%;
            box-sizing: border-box;
        }
        .carousel-btn {
            background: rgba(0,0,0,0.45);
        }
        .overlay {
            backdrop-filter: blur(3px);
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Volver al inicio -->
    <div class="max-w-6xl mx-auto px-4 pt-6">
        <a href="index.html" class="inline-flex items-center text-indigo-600 font-semibold hover:underline">
            ← Volver al inicio
        </a>
    </div>

    <!-- Contenedor central -->
    <main class="max-w-6xl mx-auto px-4 py-8">

        <!-- Formulario y CTA -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">

            <!-- Formulario -->
            <div class="lg:col-span-1">
                <div class="bg-white/90 backdrop-blur p-6 rounded-2xl shadow-lg sticky top-20">
                    <h1 class="text-2xl font-bold text-indigo-600 mb-4">Publicar un producto</h1>

                    <form id="formPublicar" class="space-y-4">

                        <div>
                            <label class="block text-sm font-medium">Título</label>
                            <input id="mpTitulo" required class="mt-1 w-full border rounded p-2" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Precio</label>
                            <input id="mpPrecio" type="number" required class="mt-1 w-full border rounded p-2" />
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Categoría</label>
                            <select id="mpCategoria" class="mt-1 w-full border rounded p-2">
                                <option>Tecnología</option>
                                <option>Hogar</option>
                                <option>Moda</option>
                                <option>Belleza</option>
                                <option>Otros</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Descripción</label>
                            <textarea id="mpDescripcion" rows="4" class="mt-1 w-full border rounded p-2"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Imágenes (máx 6)</label>
                            <input id="mpImagenes" type="file" accept="image/*" multiple class="mt-1 w-full" />
                            <p class="text-xs text-gray-500 mt-1">Al editar, si no subes nuevas imágenes se conservarán las anteriores.</p>
                        </div>

                        <div class="flex gap-2">
                            <button type="submit" id="btnPublicar" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded font-semibold">
                                Publicar
                            </button>
                            <button id="btnCancelarEdicion" type="button" class="hidden flex-1 border rounded py-2 text-gray-700">
                                Cancelar edición
                            </button>
                        </div>

                    </form>
                </div>
            </div>

            <!-- Introducción / Banner -->
            <div class="lg:col-span-2">
                <div class="bg-white/80 p-6 rounded-2xl shadow-lg mb-6">
                    <h2 class="text-3xl font-bold text-indigo-600">Marketplace</h2>
                    <p class="text-gray-600 mt-2">Publica y muestra productos. Haz clic en cualquier tarjeta para ver detalles, deslizar imágenes o editar.</p>
                </div>

                <!-- Grid de productos -->
                <div id="contenedorMarketplace" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6">
                    <!-- tarjetas dinámicas -->
                </div>
            </div>

        </section>

    </main>

    <!-- Modal detalles -->
    <div id="modalDetalles" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-9">
        <div class="bg-white rounded-2xl w-[90%] max-w-[1100px] p-10 relative shadow-2xl transform scale-110">
            <button id="cerrarModal" class="absolute top-3 right-3 text-gray-500 text-xl">✕</button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                <!-- Carrusel -->
                <div class="relative">
                    <div id="carouselContainer" class="overflow-hidden rounded-xl bg-gray-100">
                        <div id="slides" class="slides"></div>
                    </div>

                    <!-- Controls -->
                    <button id="prevBtn" class="absolute left-2 top-1/2 -translate-y-1/2 p-2 rounded-full carousel-btn text-white">
                        ‹
                    </button>
                    <button id="nextBtn" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-full carousel-btn text-white">
                        ›
                    </button>

                    <!-- Dots -->
                    <div id="carouselDots" class="flex gap-2 justify-center mt-3"></div>
                </div>

                <!-- Info -->
                <div>
                    <h3 id="detTitulo" class="text-2xl font-bold text-indigo-600 mb-2"></h3>
                    <p id="detPrecio" class="text-xl font-extrabold text-green-600 mb-2"></p>
                    <p id="detCategoria" class="text-sm text-gray-500 mb-4"></p>
                    <p id="detDescripcion" class="text-gray-700 mb-6"></p>

                    <div class="flex gap-2">
                        <button id="btnEditar" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Editar</button>
                        <button id="btnEliminar" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
/* ===========================================================
   Marketplace JS - VERSIÓN CORREGIDA
   =========================================================== */

const q = (sel) => document.querySelector(sel);
const qa = (sel) => Array.from(document.querySelectorAll(sel));

/* Elementos del formulario */
const form = q('#formPublicar');
const mpTitulo = q('#mpTitulo');
const mpPrecio = q('#mpPrecio');
const mpCategoria = q('#mpCategoria');
const mpDescripcion = q('#mpDescripcion');
const mpImagenes = q('#mpImagenes');
const contenedor = q('#contenedorMarketplace');
const btnCancelarEdicion = q('#btnCancelarEdicion');

let editIndex = null;
let imagenesOriginales = [];

/* Modal y Carousel */
const modal = q('#modalDetalles');
const cerrarModalBtn = q('#cerrarModal');
const slidesEl = q('#slides');
const dotsEl = q('#carouselDots');
const prevBtn = q('#prevBtn');
const nextBtn = q('#nextBtn');

let currentSlides = [];
let currentSlideIndex = 0;

/* ===========================================================
   Cargar y mostrar publicaciones
   =========================================================== */
function cargarMarketplace() {
    const productos = JSON.parse(localStorage.getItem('marketplace')) || [];
    productos.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));

    if (productos.length === 0) {
        contenedor.innerHTML = `
            <div class="col-span-full text-center text-gray-500 p-8 bg-white/60 rounded-xl shadow">
                No hay productos publicados aún.
            </div>
        `;
        return;
    }

    contenedor.innerHTML = productos.map((p, i) => {
        const thumb = (p.imagenes && p.imagenes.length) ? p.imagenes[0] : '';
        return `
            <article class="bg-white rounded-xl shadow hover:shadow-xl transition overflow-hidden cursor-pointer" data-index="${i}">
                <div class="h-48 bg-gray-100 overflow-hidden">
                    <img src="${thumb}" alt="${escapeHtml(p.titulo)}" class="w-full h-full object-cover">
                </div>
                <div class="p-4">
                    <h4 class="font-semibold text-lg">${escapeHtml(p.titulo)}</h4>
                    <p class="text-indigo-600 font-bold mt-1">$${Number(p.precio).toLocaleString()}</p>
                    <p class="text-gray-500 text-sm mt-2">${escapeHtml(p.categoria)}</p>
                </div>
            </article>
        `;
    }).join('');

    qa('#contenedorMarketplace > article').forEach(card => {
        card.addEventListener('click', () => {
            openDetalles(Number(card.getAttribute('data-index')));
        });
    });
}

function escapeHtml(str='') {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}

/* ===========================================================
   Publicar / Editar - UN SOLO EVENT LISTENER
   =========================================================== */
form.addEventListener('submit', async (e) => {
    e.preventDefault();

    let productos = JSON.parse(localStorage.getItem("marketplace")) || [];
    const files = mpImagenes.files;
    let imagenesFinales = [];

    // Si estamos editando y NO se subieron nuevas imágenes
    if (editIndex !== null && (!files || files.length === 0)) {
        imagenesFinales = imagenesOriginales;
    } 
    // Si hay nuevas imágenes (edición o publicación nueva)
    else if (files && files.length > 0) {
        if (files.length > 6) {
            alert("Máximo 6 imágenes.");
            return;
        }

        const toBase64 = (file) =>
            new Promise((resolve) => {
                const r = new FileReader();
                r.onload = () => resolve(r.result);
                r.readAsDataURL(file);
            });

        for (let f of files) {
            imagenesFinales.push(await toBase64(f));
        }
    }

    const nuevoProducto = {
        titulo: mpTitulo.value.trim(),
        precio: mpPrecio.value.trim(),
        categoria: mpCategoria.value,
        descripcion: mpDescripcion.value.trim(),
        imagenes: imagenesFinales,
        fecha: editIndex !== null ? productos[editIndex].fecha : new Date().toISOString()
    };

    if (editIndex !== null) {
        // Actualizar producto existente
        productos[editIndex] = nuevoProducto;
        alert("✔ Producto actualizado correctamente.");
    } else {
        // Crear nuevo producto
        productos.push(nuevoProducto);
        alert("✔ Producto publicado correctamente.");
    }

    localStorage.setItem("marketplace", JSON.stringify(productos));
    limpiarEdicion();
    cargarMarketplace();
});

/* Limpia el estado de edición */
function limpiarEdicion() {
    editIndex = null;
    imagenesOriginales = [];
    btnCancelarEdicion.classList.add("hidden");
    form.reset();
    mpImagenes.value = "";
}

/* Preparar edición */
function prepararEdicion(index) {
    let productos = JSON.parse(localStorage.getItem("marketplace")) || [];
    productos.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
    const p = productos[index];

    editIndex = index;
    imagenesOriginales = p.imagenes || [];

    mpTitulo.value = p.titulo;
    mpPrecio.value = p.precio;
    mpCategoria.value = p.categoria;
    mpDescripcion.value = p.descripcion;

    btnCancelarEdicion.classList.remove("hidden");
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* Cancelar edición */
btnCancelarEdicion.addEventListener('click', () => {
    limpiarEdicion();
});

/* ===========================================================
   Ver detalles (modal) + Carousel
   =========================================================== */
function openDetalles(index) {
    let productos = JSON.parse(localStorage.getItem('marketplace')) || [];
    productos.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
    const p = productos[index];
    if (!p) return;

    q('#detTitulo').innerText = p.titulo;
    q('#detPrecio').innerText = '$' + Number(p.precio).toLocaleString();
    q('#detCategoria').innerText = p.categoria;
    q('#detDescripcion').innerText = p.descripcion || '';

    currentSlides = p.imagenes || [];
    renderCarousel(0);

    // ELIMINAR - Funciona correctamente ahora
    q('#btnEliminar').onclick = function() {
        if (!confirm('¿Eliminar esta publicación?')) return;
        
        let productos = JSON.parse(localStorage.getItem('marketplace')) || [];
        productos.sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
        productos.splice(index, 1);
        localStorage.setItem('marketplace', JSON.stringify(productos));
        
        closeModal();
        cargarMarketplace();
        alert("✔ Producto eliminado correctamente.");
    };

    // EDITAR - Funciona correctamente ahora
    q('#btnEditar').onclick = function() {
        prepararEdicion(index);
        closeModal();
    };

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal(){
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

/* ===========================================================
   Carousel
   =========================================================== */
function renderCarousel(startIndex=0) {
    currentSlideIndex = startIndex || 0;
    slidesEl.innerHTML = '';
    dotsEl.innerHTML = '';

    if (!currentSlides || currentSlides.length === 0) {
        slidesEl.innerHTML = `<div class="slide p-6"><div class="h-64 flex items-center justify-center text-gray-500">Sin imágenes</div></div>`;
        return;
    }

    for (let i=0;i<currentSlides.length;i++){
        const img = currentSlides[i];
        const slide = document.createElement('div');
        slide.className = 'slide';
        slide.innerHTML = `<img src="${img}" class="w-full h-96 object-contain bg-gray-100 rounded-xl">`;
        slidesEl.appendChild(slide);

        const dot = document.createElement('button');
        dot.className = 'w-3 h-3 rounded-full bg-gray-300';
        dot.addEventListener('click', ()=> goToSlide(i));
        dotsEl.appendChild(dot);
    }

    updateCarouselPosition();
}

function updateCarouselPosition(){
    const offset = -currentSlideIndex * 100;
    slidesEl.style.transform = `translateX(${offset}%)`;
    updateDots();
}

function updateDots(){
    Array.from(dotsEl.children).forEach((d, idx) => {
        d.classList.toggle('bg-indigo-600', idx === currentSlideIndex);
        d.classList.toggle('bg-gray-300', idx !== currentSlideIndex);
    });
}

function prevSlide(){
    if (currentSlides.length === 0) return;
    currentSlideIndex = (currentSlideIndex - 1 + currentSlides.length) % currentSlides.length;
    updateCarouselPosition();
}

function nextSlide(){
    if (currentSlides.length === 0) return;
    currentSlideIndex = (currentSlideIndex + 1) % currentSlides.length;
    updateCarouselPosition();
}

function goToSlide(i){
    currentSlideIndex = i;
    updateCarouselPosition();
}

/* Swipe support */
let startX = null;
q('#carouselContainer').addEventListener('touchstart', function(e){
    if (!e.touches || e.touches.length === 0) return;
    startX = e.touches[0].clientX;
});

q('#carouselContainer').addEventListener('touchend', function(e){
    if (startX === null) return;
    const endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : null;
    if (endX === null) { startX = null; return; }
    const diff = startX - endX;
    if (Math.abs(diff) > 30) {
        if (diff > 0) nextSlide(); else prevSlide();
    }
    startX = null;
});

prevBtn.addEventListener('click', (e)=> { e.stopPropagation(); prevSlide(); });
nextBtn.addEventListener('click', (e)=> { e.stopPropagation(); nextSlide(); });
cerrarModalBtn.addEventListener('click', closeModal);

modal.addEventListener('click', (e)=>{
    if (e.target === modal) closeModal();
});

/* ===========================================================
   Inicialización
   =========================================================== */
document.addEventListener('DOMContentLoaded', () => {
    cargarMarketplace();
});

</script>

</body>
</html>